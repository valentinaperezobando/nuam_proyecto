{% extends 'base.html' %}
{% load static %}
{% load calificacion_tags %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-md-10 offset-md-1">
            <!-- Encabezado -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold">
                    <i class="bi bi-file-text"></i>
                    Detalle de Calificación Tributaria
                </h2>
                <a href="{% url 'listar_calificaciones' %}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Volver al Listado
                </a>
            </div>

            <!-- Información General -->
            <div class="card shadow mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Información General</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-5">ID:</dt>
                                <dd class="col-sm-7">{{ calificacion.id }}</dd>

                                <dt class="col-sm-5">Ejercicio:</dt>
                                <dd class="col-sm-7"><strong>{{ calificacion.ejercicio }}</strong></dd>

                                <dt class="col-sm-5">Mercado:</dt>
                                <dd class="col-sm-7">{{ calificacion.mercado }}</dd>

                                <dt class="col-sm-5">Instrumento:</dt>
                                <dd class="col-sm-7">{{ calificacion.instrumento }}</dd>

                                <dt class="col-sm-5">Fecha de Pago:</dt>
                                <dd class="col-sm-7">{{ calificacion.fecha_pago|date:"d/m/Y" }}</dd>

                                <dt class="col-sm-5">Secuencia Evento:</dt>
                                <dd class="col-sm-7">{{ calificacion.secuencia_evento }}</dd>
                            </dl>
                        </div>

                        <div class="col-md-6">
                            <dl class="row">
                                <dt class="col-sm-5">Estado:</dt>
                                <dd class="col-sm-7">
                                    {% if calificacion.estado == 'completado' %}
                                        <span class="badge bg-success">Completado</span>
                                    {% elif calificacion.estado == 'pendiente' %}
                                        <span class="badge bg-warning text-dark">Pendiente</span>
                                    {% elif calificacion.estado == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ calificacion.estado|capfirst }}</span>
                                    {% endif %}
                                </dd>

                                <dt class="col-sm-5">Origen:</dt>
                                <dd class="col-sm-7">{{ calificacion.get_origen_display }}</dd>

                                <dt class="col-sm-5">Valor Histórico:</dt>
                                <dd class="col-sm-7">${{ calificacion.valor_historico|floatformat:2 }}</dd>

                                <dt class="col-sm-5">Dividendo:</dt>
                                <dd class="col-sm-7">${{ calificacion.dividendo|floatformat:2 }}</dd>

                                <dt class="col-sm-5">Creado por:</dt>
                                <dd class="col-sm-7">{{ calificacion.creado_por.username }}</dd>

                                <dt class="col-sm-5">Fecha Creación:</dt>
                                <dd class="col-sm-7">{{ calificacion.fecha_creacion|date:"d/m/Y H:i" }}</dd>
                            </dl>
                        </div>
                    </div>

                    {% if calificacion.descripcion %}
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Descripción:</h6>
                            <p class="text-muted">{{ calificacion.descripcion }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if calificacion.evento_capital %}
                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Evento de Capital:</h6>
                            <p class="text-muted">{{ calificacion.evento_capital }}</p>
                        </div>
                    </div>
                    {% endif %}

                    {% if calificacion.observaciones %}
                    <div class="row">
                        <div class="col-12">
                            <h6 class="border-bottom pb-2">Observaciones:</h6>
                            <p class="text-muted">{{ calificacion.observaciones }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Factores Tributarios -->
            <div class="card shadow mb-4">
                <div class="card-header bg-info text-dark">
                    <h5 class="mb-0">Factores Tributarios</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-striped">
                            <thead class="table-light">
                                <tr>
                                    <th>Factor</th>
                                    <th>Valor Ingresado</th>
                                    <th>Valor Calculado</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Factor 08 -->
                                <tr>
                                    <td><strong>Factor 08</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_8'|default:"0.00000000" }}</td>
                                    <td>
                                        {% if calificacion.factores_calculados|get_item:'factor_8' %}
                                            <span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_8' }}</span>
                                        {% else %}<span class="text-muted">-</span>{% endif %}
                                    </td>
                                    
                                </tr>

                                <!-- Factor 09 -->
                                <tr>
                                    <td><strong>Factor 09</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_9'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_9' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_9' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                   
                                </tr>

                                <!-- Factor 10 -->
                                <tr>
                                    <td><strong>Factor 10</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_10'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_10' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_10' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                   
                                </tr>

                                <!-- Factor 11 -->
                                <tr>
                                    <td><strong>Factor 11</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_11'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_11' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_11' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 12 -->
                                <tr>
                                    <td><strong>Factor 12</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_12'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_12' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_12' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 13 -->
                                <tr>
                                    <td><strong>Factor 13</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_13'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_13' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_13' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 14 -->
                                <tr>
                                    <td><strong>Factor 14</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_14'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_14' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_14' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                   
                                </tr>

                                <!-- Factor 15 -->
                                <tr>
                                    <td><strong>Factor 15</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_15'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_15' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_15' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 16 -->
                                <tr>
                                    <td><strong>Factor 16</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_16'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_16' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_16' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                   
                                </tr>

                                <!-- Factor 17 -->
                                <tr>
                                    <td><strong>Factor 17</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_17'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_17' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_17' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 18 -->
                                <tr>
                                    <td><strong>Factor 18</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_18'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_18' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_18' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 19 -->
                                <tr>
                                    <td><strong>Factor 19</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_19'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_19' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_19' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 20 -->
                                <tr>
                                    <td><strong>Factor 20</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_20'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_20' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_20' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                   
                                </tr>

                                <!-- Factor 21 -->
                                <tr>
                                    <td><strong>Factor 21</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_21'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_21' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_21' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 22 -->
                                <tr>
                                    <td><strong>Factor 22</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_22'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_22' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_22' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                    
                                </tr>

                                <!-- Factor 23 -->
                                <tr>
                                    <td><strong>Factor 23</strong></td>
                                    <td>{{ calificacion.factores|get_item:'factor_23'|default:"0.00000000" }}</td>
                                    <td>{% if calificacion.factores_calculados|get_item:'factor_23' %}<span class="text-primary">{{ calificacion.factores_calculados|get_item:'factor_23' }}</span>{% else %}<span class="text-muted">-</span>{% endif %}</td>
                                </tr>

                                <!-- Factor 24 al 37: Copiar y pegar el mismo patrón cambiando el número -->
                                {% for i in "24,25,26,27,28,29,30,31,32,33,34,35,36,37"|split:"," %}
                                    <tr>
                                        <td><strong>Factor {{ i }}</strong></td>
                                        <td>{{ calificacion.factores|get_item:'factor_23'|default:"0.00000000" }}</td>
                                        <!-- <td>
                                            {% with factor_key='factor_'|add:i %}
                                                {% if calificacion.factores|get_item:factor_key %}
                                                    <span>{{ calificacion.factores|get_item:factor_key }}</span>
                                                {% else %}
                                                    <span class="text-muted">0</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td> -->
                                        <td>
                                            {% with factor_key='factor_'|add:i %}
                                                {% if calificacion.factores_calculados|get_item:factor_key %}
                                                    <span class="text-primary">{{ calificacion.factores_calculados|get_item:factor_key }}</span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% endwith %}
                                        </td>
                                    </tr>
                                {% endfor %}
                                 </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Errores de Validación -->
            {% if calificacion.errores_validacion %}
            <div class="card shadow mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        Errores y Advertencias de Validación
                    </h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        {% for error in calificacion.errores_validacion %}
                        <li class="list-group-item">
                            <strong>{{ error.tipo|default:"Error" }}:</strong> {{ error.mensaje }}
                            {% if error.campo %}
                                <span class="badge bg-secondary ms-2">{{ error.campo }}</span>
                            {% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Historial de Cambios -->
            {% if historial %}
            <div class="card shadow mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clock-history"></i>
                        Historial de Cambios (Últimos 10)
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha</th>
                                    <th>Usuario</th>
                                    <th>Acción</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in historial %}
                                <tr>
                                    <td>{{ item.fecha|date:"d/m/Y H:i" }}</td>
                                    <td>{{ item.usuario.username }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if item.accion == 'creacion' %}bg-success
                                            {% elif item.accion == 'modificacion' %}bg-primary
                                            {% elif item.accion == 'calculo' %}bg-info
                                            {% else %}bg-secondary{% endif %}">
                                            {{ item.accion|capfirst }}
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            {% if item.cambios.tipo %}
                                                {{ item.cambios.tipo }}
                                            {% elif item.accion == 'modificacion' %}
                                                Campos actualizados
                                            {% elif item.accion == 'calculo' %}
                                                Factores recalculados
                                            {% else %}
                                                -
                                            {% endif %}
                                        </small>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Acciones -->
            <div class="card shadow">
                <div class="card-body">
                    <div class="d-flex gap-2 justify-content-between">
                        <a href="{% url 'listar_calificaciones' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Volver
                        </a>
                        <div class="d-flex gap-2">
                            <a href="{% url 'calcular_factores' calificacion.id %}" class="btn btn-info">
                                <i class="bi bi-calculator"></i> Recalcular Factores
                            </a>
                            <a href="{% url 'editar_calificacion' calificacion.id %}" class="btn btn-warning">
                                <i class="bi bi-pencil"></i> Editar
                            </a>
                            <a href="{% url 'eliminar_calificacion' calificacion.id %}" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Eliminar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}