{%extends 'base.html'%}
{%load static%}
{%block content%}
<div>
    <h1 class="text-center py-4">Carga de archivos</h1>
    <form action="{% url 'carga_masiva' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <div class="row">
            <div class="col-md-2"></div>
            <div class="col-md-8">
                <div id="dropzone" class="border border-2 border-dashed rounded-3 p-5 text-center bg-light">
                    <p class="mb-2 fw-semibold">Arrastra tu archivo aqu√≠ o haz clic para seleccionarlo</p>
                    <input
                    type="file"
                    name="archivo"
                    multiple
                    id="archivo"
                    accept=".pdf,.csv,.xls,.xlsx"
                    class="d-none"
                    />
                    <button type="button" id="btnSelect" class="btn btn-outline-primary">
                    Seleccionar archivo
                    </button>
                    <div id="file-list" class="mt-3 text-start"></div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-3 offset-md-9 text-end mt-2 py-3">
                    <input type="submit" value="Grabar" class="btn btn-outline-success">                    
                </div>
            </div>
        </div>
    </form>

    {%if archivos%}

    <table class="table">
        <tr>
            <th>Nombre archivo</th>
            <th>Tipo</th>
            <th>Estado</th>
            <th>Acciones</th>
        </tr>
        {%for archivo in archivos%}
        <tr>
            <th>{{archivo.nombre}}</th>
            <th>{{archivo.tipo}}</th>
            <th>{{archivo.estado}}</th>
            {%if archivo.estado == 'NORMALIZADO'%}
            <td>
                <a href="/carga_masiva/detalles_registro/{{archivo.id}}" class="btn btn-primary btn-sm">Ver detalles</a>
                <a href="/carga_masiva/eliminar_archivo/{{archivo.id}}" class="btn btn-danger btn-sm btn-eliminar">Eliminar</a>
            </td>
            {%else%}
            <td>
                <a href="/carga_masiva/normalizar/{{archivo.id}}" class="btn btn-warning btn-sm">Normalizar</a>
                <a href="/carga_masiva/eliminar_archivo/{{archivo.id}}" class="btn btn-danger btn-sm btn-eliminar">Eliminar</a>
            </td>
            {%endif%}
        </tr>

        {%endfor%}
    </table>

    {%endif%}
</div>



<script>
    document.addEventListener('DOMContentLoaded', ()=> {
        const dropzone = document.getElementById('dropzone');
        const inputFile = document.getElementById('archivo');
        const btnSelect = document.getElementById('btnSelect');
        const fileList = document.getElementById("file-list");

        let filesArray = [];

        dropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        dropzone.classList.add("bg-light");
        });

        dropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        dropzone.classList.remove("bg-light");
        handleFiles(e.dataTransfer.files);
        });

        btnSelect.addEventListener('click', () => inputFile.click());

        //Cuando seleccionann archivos desde el dialogo
        inputFile.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(newFiles) {
            for (let file of newFiles) {
                if (!filesArray.some((f) => f.name === file.name && f.size === file.size)) {
                    filesArray.push(file);
                }
            }
        mostrarArchivosLista();
        actualizarInputFiles();
        
        }

        function mostrarArchivosLista() {
            fileList.innerHTML= "";

            if (filesArray.length === 0) {
                fileList.innerHTML = "<p class='text-muted'>No hay archivos seleccionados</p>"
                return;
            }
            const ul = document.createElement('ul');
            ul.classList.add('list-group');

            filesArray.forEach((file, index) => {
                const li = document.createElement('li');
                li.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'align-items-center');
                li.innerHTML = `
                <span>üìÑ ${file.name} (${(file.size / 1024).toFixed(1)} KB)</span>
                <button type="button" class="btn btn-sm btn-outline-danger">üóëÔ∏è</button>
                `;
                li.querySelector('button').addEventListener('click', () => {
                    filesArray.splice(index, 1);
                    mostrarArchivosLista();
                    actualizarInputFiles();
                });
                ul.appendChild(li);
                });
                fileList.appendChild(ul);
            }
            function actualizarInputFiles() {
                const dataTransfer = new DataTransfer();
                filesArray.forEach((file) => dataTransfer.items.add(file));
                inputFile.files = dataTransfer.files;
            }
        });
</script>
{%endblock%}